<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Food Posting</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
      rel="stylesheet"
    />
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        get,
        child,
        remove,
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDdZDK-BrKpSA-BIzPory1HG9Kljr3m7PI",
        authDomain: "saveplate-c246d.firebaseapp.com",
        projectId: "saveplate-c246d",
        storageBucket: "saveplate-c246d.firebasestorage.app",
        messagingSenderId: "120081276324",
        appId: "1:120081276324:web:16985cfc7662a80502b531",
        measurementId: "G-75P3TNTKK7",
        databaseURL: "https://saveplate-c246d-default-rtdb.firebaseio.com/",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      window.foodPosts = [];

      // Function to fetch all food posts from Firebase
      window.getFoodPostsFromFirebase = function getFoodPostsFromFirebase() {
        const dbRef = ref(db);
        get(child(dbRef, `foodPosts`))
          .then((snapshot) => {
            if (snapshot.exists()) {
              window.foodPosts = [];
              snapshot.forEach((childSnapshot) => {
                const item = childSnapshot.val();
                item.id = childSnapshot.key;
                window.foodPosts.push(item);
              });
              renderFoodPosts();
            }
          })
          .catch((error) => {
            console.error("Error fetching food posts: ", error);
          });
      };

      // Function to delete a food post from Firebase
      window.deleteFoodPostFromFirebase =
        async function deleteFoodPostFromFirebase(postId) {
          try {
            const postRef = ref(db, `foodPosts/${postId}`);
            await remove(postRef);
            alert("Food post deleted successfully.");
            window.foodPosts = window.foodPosts.filter(
              (item) => item.id !== postId
            );
            renderFoodPosts();
          } catch (error) {
            console.error("Error deleting food post: ", error);
            alert("Error deleting food post. Please try again.");
          }
        };

      // Initial rendering of the food posts
      document.addEventListener("DOMContentLoaded", function () {
        // Load navbar
        const userRole = localStorage.getItem("userRole");

        if (userRole === "Restaurant Manager") {
          fetch("managerNavbar.html")
            .then((response) => response.text())
            .then((data) => {
              document.getElementById("navbar-container").innerHTML = data;
            });
        } else if (userRole === "Volunteer") {
          fetch("volunteerNavbar.html")
            .then((response) => response.text())
            .then((data) => {
              document.getElementById("navbar-container").innerHTML = data;
            });
        }

        getFoodPostsFromFirebase();
      });
    </script>
    <script>
      function renderFoodPosts() {
        const table = document.getElementById("foodPostsTable");
        table.innerHTML = "";

        window.foodPosts.forEach((item) => {
          if (item.status !== "donated") {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td class="border px-6 py-6 text-gray-900 font-semibold rounded-l-lg shadow-lg" role="cell">${item.name}</td>
              <td class="border px-6 py-6 text-gray-900 font-semibold shadow-lg" role="cell">${item.quantity}</td>
              <td class="border px-6 py-6 text-gray-900 font-semibold shadow-lg" role="cell">${item.expiryDate}</td>
              <td class="border px-6 py-6 rounded-r-lg shadow-lg" role="cell">
                <div class="flex space-x-3">
                  <button onclick="deleteFoodPostFromFirebase('${item.id}')" 
                          class="btn bg-red-600 text-white font-semibold hover:bg-red-700 py-2 px-6 rounded-lg transition duration-300 shadow-md"
                          aria-label="Remove post for ${item.name}">
                    Remove Post
                  </button>
                </div>
              </td>
            `;
            table.appendChild(row);
          }
        });
      }

      function signOut() {
        localStorage.clear();
        alert("You have been signed out.");
        window.location.href = "index.html";
      }
    </script>
    <style>
      body {
        background: linear-gradient(to bottom, #a8d5ba, #dff3e4);
        color: #1a202c;
        font-family: "Arial", sans-serif;
      }

      .main-nav {
        display: flex;
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .main-nav li {
        margin-right: 1.5rem;
      }

      .main-nav a {
        color: white;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        transition: background-color 0.3s;
      }

      .main-nav a:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }

      table {
        border-collapse: separate;
        border-spacing: 0 15px;
        width: 100%;
        margin-top: 20px;
      }

      th {
        background-color: #1a365d;
        color: white;
        font-weight: 600;
        padding: 1rem 1.5rem;
        text-align: left;
        border-bottom: 2px solid #2d4ed8;
      }

      td {
        background-color: white;
        padding: 1rem 1.5rem;
      }

      .btn {
        transition: all 0.3s ease;
      }

      .btn:hover {
        transform: translateY(-2px);
      }

      .food-posts-container {
        background: #f0f9ff;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      .signout-btn {
        background-color: #dc2626;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
      }

      .signout-btn:hover {
        background-color: #b91c1c;
      }
    </style>
  </head>
  <body class="min-h-screen">
    <header class="bg-slate-800 text-white py-4 shadow-lg">
      <div class="container mx-auto px-4">
        <div class="flex justify-between items-center">
          <h1 class="text-2xl font-bold">Save Plate</h1>
          <nav aria-label="Main navigation">
            <ul class="main-nav">
              <li><a href="#" class="nav-link">Home</a></li>
              <li><a href="#" class="nav-link">Inventory</a></li>
              <li><a href="#" class="nav-link">Food Posting</a></li>
              <li><a href="#" class="nav-link">Donation Reqs</a></li>
              <li><a href="#" class="nav-link">Waste Logs</a></li>
              <li><a href="#" class="nav-link">Messaging</a></li>
              <li><a href="#" class="nav-link">Profile</a></li>
              <li><a href="#" class="nav-link">Notifications</a></li>
              <li>
                <button onclick="signOut()" class="signout-btn">
                  <span>Sign Out</span>
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 3a1 1 0 011 1v12a1 1 0 11-2 0V4a1 1 0 011-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"/>
                  </svg>
                </button>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </header>

    <main class="container mx-auto px-4 py-8">
      <h2 class="text-3xl font-bold text-gray-900 mb-8">Food Posting</h2>
      
      <div class="food-posts-container">
        <table role="table" aria-label="Food Posts">
          <thead>
            <tr>
              <th scope="col" role="columnheader" class="font-semibold">Item Name</th>
              <th scope="col" role="columnheader" class="font-semibold">Quantity</th>
              <th scope="col" role="columnheader" class="font-semibold">Expiry Date</th>
              <th scope="col" role="columnheader" class="font-semibold">Actions</th>
            </tr>
          </thead>
          <tbody id="foodPostsTable" role="rowgroup">
            <!-- Food posts will be rendered here -->
          </tbody>
        </table>
      </div>
    </main>
  </body>
</html>
